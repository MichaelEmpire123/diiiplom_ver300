{% extends 'base.html' %}

{% block title %}Подача обращения{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2 class="text-center">Подача обращения</h2>
        <form method="post" enctype="multipart/form-data" class="needs-validation mt-4" novalidate>
            {% csrf_token %}

            <!-- Категория и описание проблемы -->
            {{ form.id_category.label_tag }} {{ form.id_category }}
            {{ form.description_problem.label_tag }} {{ form.description_problem }}

            <br>

            <!-- Скрытое стандартное поле загрузки -->
            <input type="file" id="id_photo" name="photo" class="d-none" accept="image/*" multiple onchange="previewImages(event)">

            <!-- Drag & Drop область -->
            <div id="drop-area" class="border border-primary p-3 text-center rounded mb-3"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event)">
                <p class="mb-2">Перетащите изображение сюда или</p>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('id_photo').click();">
                    Выбрать изображение
                </button>
            </div>

            <!-- Блок для предпросмотра -->
            <div id="file-list" class="d-flex flex-wrap"></div>

            <button type="submit" class="btn btn-primary mt-3">Отправить</button>
        </form>
    </div>
</div>

<script>
    function previewImages(event) {
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = ''; // Очистить список перед новым выбором

        const files = event.target.files;

        for (let i = 0; i < files.length; i++) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgElement = document.createElement('img');
                imgElement.src = e.target.result;
                imgElement.style.width = '120px';
                imgElement.style.height = '120px';
                imgElement.style.objectFit = 'cover';
                imgElement.style.margin = '10px';
                imgElement.classList.add('rounded', 'shadow-sm');
                fileList.appendChild(imgElement);
            }
            reader.readAsDataURL(files[i]);
        }
    }

    function handleDragOver(event) {
        event.preventDefault();
        document.getElementById('drop-area').classList.add('bg-light');
    }

    function handleDragLeave(event) {
        document.getElementById('drop-area').classList.remove('bg-light');
    }

    function handleDrop(event) {
        event.preventDefault();
        document.getElementById('drop-area').classList.remove('bg-light');

        const files = event.dataTransfer.files;
        const input = document.getElementById('id_photo');

        const dataTransfer = new DataTransfer();
        for (let i = 0; i < files.length; i++) {
            dataTransfer.items.add(files[i]);
        }
        input.files = dataTransfer.files;

        previewImages({ target: input });
    }
</script>

{% endblock %}
