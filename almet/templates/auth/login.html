{% extends 'base.html' %}

{% block title %}–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2 class="text-center">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <form id="loginForm" method="post" class="mt-4" onsubmit="return validateLoginInput()">
            {% csrf_token %}
            <div class="mb-3">
                <label for="login_input" class="form-label">Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</label>
                <input title="–ß—Ç–æ–±—ã –≤–≤–µ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Å +7" type="text" class="form-control" id="login_input" name="login_input" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–æ—á—Ç—É">
                <div class="invalid-feedback">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω.</div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å">
                    <button type="button" class="btn btn-outline-secondary" id="togglePassword" onclick="togglePasswordVisibility('password', 'togglePassword')">üëÅÔ∏è‚Äçüó®Ô∏è</button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
        </form>
        <div id="message" class="mt-3"></div> <!-- –ë–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    function togglePasswordVisibility(inputId, buttonId) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        if (input.type === "password") {
            input.type = "text";
            button.innerHTML = "üëÅÔ∏è";
        } else {
            input.type = "password";
            button.innerHTML = "üëÅÔ∏è‚Äçüó®Ô∏è";
        }
    }

    $(document).ready(function() {
        $('#login_input').on('input', function() {
            let inputVal = $(this).val();

            if (inputVal.startsWith("+7")) {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                $(this).mask('+7 (000) 000-00-00');
            } else {
                // –£–±–∏—Ä–∞–µ–º –º–∞—Å–∫—É, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω
                $(this).unmask();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        $('#loginForm').on('submit', function(e) {
            e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

            // –ü–æ–ª—É—á–∞–µ–º CSRF-—Ç–æ–∫–µ–Ω
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

            $.ajax({
                url: '{% url "login" %}',  // URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                type: 'POST',
                headers: {
                    "X-CSRFToken": csrfToken  // –ü–µ—Ä–µ–¥–∞–µ–º CSRF-—Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                },
                data: $(this).serialize(),  // –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                success: function(response) {
                    if (response.success) {
                        $('#message').html('<div class="alert alert-success">' + response.message + '</div>');
                        if (response.redirect) {
                            window.location.href = response.redirect;  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è
                        }
                    } else {
                        $('#message').html('<div class="alert alert-danger">' + response.message + '</div>');
                    }
                },
                error: function() {
                    $('#message').html('<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö.</div>');
                }
            });
        });
    });

    function validateLoginInput() {
        let input = document.getElementById('login_input');
        let value = input.value.trim();
        let emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        let phonePattern = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;

        if (emailPattern.test(value) || phonePattern.test(value)) {
            input.classList.remove("is-invalid");
            return true;
        } else {
            input.classList.add("is-invalid");
            return false;
        }
    }
</script>
{% endblock %}