{% extends 'base.html' %}
{% load static %}
{% block title %}Чат{% endblock %}

{% block content %}
<div class="container mt-4" style="height: 100vh; display: flex; flex-direction: column;">

    <!-- Контейнер для сообщений, ограниченный по высоте до формы -->
    <div class="chat d-flex flex-column gap-3" id="chat-messages" style="flex-grow: 1; overflow-y: auto; max-height: calc(100vh - 120px);">
        {% for message in chat_messages %}
            <div class="d-flex {% if message.sender == user %} justify-content-end {% else %} align-items-start {% endif %}">
                <div class="message {% if message.sender == user %} bg-primary {% else %} bg-success {% endif %} text-white p-2 rounded w-50" style="font-size: 0.9rem;">
                    <div class="fw-bold">
                        {{ message.sender.surname }} {{ message.sender.name }}
                    </div>
                    <p>{{ message.message }}</p>
                    {% if message.image %}
                        <img src="{{ message.image.url }}" class="img-fluid mt-2" alt="Отправленное фото">
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Форма для отправки сообщений, закреплена снизу -->
    <form id="message-form" method="POST" enctype="multipart/form-data" class="input-group mt-3" style="position: fixed; bottom: 10px; left: 0; right: 0; z-index: 10; max-width: 80%; margin: 0 auto;">
        {% csrf_token %}
        <input type="text" name="message" class="form-control" placeholder="Введите ваше сообщение" id="message-input">
        <label class="input-group-text" for="fileInput">
            <img src="{% static 'img/paperclip.svg' %}" alt="прикрепить фото">
        </label>
        <input type="file" name="image" class="d-none" id="fileInput" accept="image/*">
        <button type="submit" class="btn btn-primary">Отправить</button>
    </form>
</div>

<script>
    const chatMessages = document.getElementById('chat-messages');

    // Прокручиваем чат вниз при загрузке страницы
    window.addEventListener('load', function() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/{{ appeal.id }}/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        const messageElement = document.createElement('div');
        messageElement.classList.add('d-flex');

        // Определяем, кто отправил сообщение
        if (data.sender_id === {{ user.id }}) {
            messageElement.classList.add('justify-content-end');
        } else {
            messageElement.classList.add('align-items-start');
        }

        const messageContent = document.createElement('div');
        messageContent.classList.add('message', 'text-white', 'p-2', 'rounded', 'w-50');
        messageContent.style.fontSize = '0.9rem';

        // Цвет фона в зависимости от отправителя
        if (data.sender_id === {{ user.id }}) {
            messageContent.classList.add('bg-primary');
        } else {
            messageContent.classList.add('bg-success');
        }

        const senderName = document.createElement('div');
        senderName.classList.add('fw-bold');
        senderName.innerText = data.sender;  // Отображаем имя отправителя

        const messageText = document.createElement('p');
        messageText.innerText = data.message;

        messageContent.appendChild(senderName);
        messageContent.appendChild(messageText);

        if (data.image_url) {
            const imageElement = document.createElement('img');
            imageElement.src = data.image_url;
            imageElement.classList.add('img-fluid', 'mt-2');
            messageContent.appendChild(imageElement);
        }

        messageElement.appendChild(messageContent);
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;  // Прокрутка вниз для последнего сообщения
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        const fileInput = document.getElementById('fileInput');

        if (!message && fileInput.files.length === 0) {
            return; // Не отправляем пустые сообщения
        }

        const senderName = '{{ user.first_name }} {{ user.last_name }}';  // Передаем имя пользователя

        const data = {
            'message': message,
            'sender': senderName,  // Отправляем имя пользователя
            'sender_id': {{ user.id }},
        };

        if (fileInput.files.length > 0) {
            data.image_url = URL.createObjectURL(fileInput.files[0]);
        }

        chatSocket.send(JSON.stringify(data));

        messageInput.value = '';
    });
</script>
{% endblock %}
