{% extends 'base.html' %}
{% load static %}
{% block title %}Чат{% endblock %}

{% block content %}
<div class="container mt-4" style="height: 100vh; display: flex; flex-direction: column;">

    <!-- История сообщений отображается через Django -->
    <div class="chat d-flex flex-column gap-3" id="chat-messages" style="flex-grow: 1; overflow-y: auto; max-height: calc(100vh - 120px);">
        {% for message in chat_messages %}
            <div class="d-flex {% if message.sender == user %} justify-content-end {% else %} align-items-start {% endif %}">
                <div class="message {% if message.sender == user %} bg-primary {% else %} bg-success {% endif %} text-white p-2 rounded w-50" style="font-size: 0.9rem;">
                    <!-- Имя отправителя отображается только для получателя -->
                    {% if message.sender != user %}
                        <div class="fw-bold">
                            {% if message.sender.id_citizen %}
                                <!-- Для жителя -->
                                {{ message.sender.id_citizen.surname }} {{ message.sender.id_citizen.name }}
                            {% elif message.sender.id_sotrudnik %}
                                <!-- Для сотрудника -->
                                {{ message.sender.id_sotrudnik.id_service.name }}
                            {% else %}
                                <!-- Для администратора -->
                                Админ
                            {% endif %}
                        </div>
                    {% endif %}
                    <p>{{ message.message }}</p>
                    {% if message.image %}
                        <img src="{{ message.image.url }}" class="img-fluid mt-2" alt="Отправленное фото">
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Форма для отправки сообщений -->
    <form id="message-form" method="POST" enctype="multipart/form-data" class="input-group mt-3" style="position: fixed; bottom: 10px; left: 0; right: 0; z-index: 10; max-width: 80%; margin: 0 auto;">
        {% csrf_token %}
        <input type="text" name="message" class="form-control" placeholder="Введите ваше сообщение" id="message-input">
        <label class="input-group-text" for="fileInput">
            <img src="{% static 'img/paperclip.svg' %}" alt="прикрепить фото">
        </label>
        <input type="file" name="image" class="d-none" id="fileInput" accept="image/*">
        <button type="submit" class="btn btn-primary">Отправить</button>
    </form>

</div>

<script>
    const chatMessages = document.getElementById('chat-messages');

    // Прокручиваем чат вниз при загрузке страницы
    window.addEventListener('load', function() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/{{ appeal.id }}/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Received data:", data);  // Для отладки

        // Проверяем, отправил ли пользователь сообщение
        const messageElement = document.createElement('div');
        messageElement.classList.add('d-flex');

        // Если это сообщение текущего пользователя, то отображаем его справа
        if (data.sender_id === {{ user.id }}) {
            messageElement.classList.add('justify-content-end');
        } else {
            messageElement.classList.add('align-items-start');
        }

        // Создаем контейнер для сообщения
        const messageContent = document.createElement('div');
        messageContent.classList.add('message', 'text-white', 'p-2', 'rounded', 'w-50');
        messageContent.style.fontSize = '0.9rem';

        // Цвет фона в зависимости от отправителя
        if (data.sender_id === {{ user.id }}) {
            messageContent.classList.add('bg-primary');
        } else {
            messageContent.classList.add('bg-success');
        }

        // Имя отправителя отображается только для получателя
        if (data.sender_id !== {{ user.id }}) {
            const senderName = document.createElement('div');
            senderName.classList.add('fw-bold');
            senderName.innerText = data.sender_name || 'Неизвестный пользователь';
            messageContent.appendChild(senderName);
        }

        const messageText = document.createElement('p');
        messageText.innerText = data.message;

        messageContent.appendChild(messageText);

        // Если есть изображение, показываем его
        if (data.image_url) {
            const imageElement = document.createElement('img');
            imageElement.src = data.image_url;
            imageElement.classList.add('img-fluid', 'mt-2');
            messageContent.appendChild(imageElement);
        }

        messageElement.appendChild(messageContent);
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;  // Прокрутка вниз для последнего сообщения
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        const fileInput = document.getElementById('fileInput');

        if (!message && fileInput.files.length === 0) {
            return; // Не отправляем пустые сообщения
        }

        // Создаем объект FormData для отправки текста и изображения
        const formData = new FormData();
        formData.append('message', message);
        formData.append('sender_name', '{{ user.get_full_name }}');
        formData.append('sender_id', {{ user.id }});

        if (fileInput.files.length > 0) {
            formData.append('image', fileInput.files[0]);
        }

        // Отправка данных на WebSocket-сервер
        const reader = new FileReader();
        reader.onload = function(event) {
            const imageData = event.target.result;
            const data = {
                'message': message,
                'sender_name': '{{ user.get_full_name }}',
                'sender_id': {{ user.id }},
                'image': imageData  // Передаем изображение в формате base64
            };
            chatSocket.send(JSON.stringify(data));
        };

        if (fileInput.files.length > 0) {
            reader.readAsDataURL(fileInput.files[0]);  // Чтение файла как base64
        } else {
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender_name': '{{ user.get_full_name }}',
                'sender_id': {{ user.id }}
            }));
        }

        // Очищаем поле ввода и сбрасываем файл
        messageInput.value = '';
        fileInput.value = '';
    });
</script>

{% endblock %}